<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/marketLayout.html}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[[${headerInfo.hd_title}]]:[[${headerInfo.hd_subtitle}]]</title>
    <link rel="stylesheet" th:href="@{/css/market/marketList.css}">
    <link rel="stylesheet" th:href="@{/css/market/marketAside.css}">
    <script>
        document.querySelectorAll('.seller-rating').forEach(function(ratingElement) {
            const rating = parseFloat(ratingElement.getAttribute('data-rating'));
            console.log("Rating:", rating);  // rating 값 확인용 로그

            if (isNaN(rating)) {
                console.warn("Rating attribute is missing or not a number.");
                return;  // rating 값이 유효하지 않으면 생성을 중단
            }

            const fullStars = Math.floor(rating);
            const halfStar = rating % 1 !== 0;

            // 꽉 찬 별 추가
            for (let i = 0; i < fullStars; i++) {
                const star = document.createElement('span');
                star.classList.add('star', 'full-star');
                star.innerHTML = '★';
                ratingElement.appendChild(star);
            }

            // 반쪽 별 추가
            if (halfStar) {
                const star = document.createElement('span');
                star.classList.add('star', 'half-star');
                star.innerHTML = '★';
                ratingElement.appendChild(star);
            }

            // 빈 별 추가
            const emptyStars = 5 - fullStars - (halfStar ? 1 : 0);
            for (let i = 0; i < emptyStars; i++) {
                const star = document.createElement('span');
                star.classList.add('star', 'empty-star');
                star.innerHTML = '☆'; // 빈 별
                ratingElement.appendChild(star);
            }
        });

        let currentPage = 1;

        window.onload = function (){
            const paginationInfo = document.getElementById("paginationInfo");
            const totalPages = parseInt(paginationInfo.getAttribute("data-total-pages"));
            const sort = paginationInfo.getAttribute("data-sort"); // sort 조건 가져오기

            window.addEventListener('scroll', function() {
                if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 10) {
                    if (currentPage < totalPages) {
                        loadMoreProducts(sort);
                    }
                }
            });
            function loadMoreProducts(sort) {
                currentPage++;

                // sort 파라미터를 URL에 추가하여 서버로 요청
                fetch(`/market/list/{{categoryId}}?page=${currentPage}&sort=${sort}`)
                    .then(response => response.text())
                    .then(html => {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');
                        const newProducts = doc.querySelectorAll('.product-item');

                        newProducts.forEach(product => {
                            document.querySelector('.product-list').appendChild(product);
                        });
                    })
                    .catch(error => console.error('Error loading more products:', error));
            }

            document.addEventListener("DOMContentLoaded", function() {
                document.querySelectorAll('.shipping-fee').forEach(function() {

                    // shippingFee 값을 가져와 숫자로 변환
                    const shippingFee = parseFloat(feeElement.innerText);
                    console.log("shippingFee"+shippingFee);

                    // shippingFee가 0이면 무료배송으로 텍스트 변경 및 클래스 추가
                    if (shippingFee === 0) {
                        feeElement.innerText = "무료배송";
                        feeElement.classList.add("shipping-label");
                    }
                });

            });
        }
    </script>

</head>
<body>
<th:block layout:fragment="content">
    <th:block th:replace="~{aside/marketAside}"></th:block>
                <section class="section list">
                    <input type="hidden" id="totalPages" th:data-total-pages="${responseDTO.getTotal()}" th:data-sort="${sort}">

                    <div class="sectionWrapper">
                        <div class="sub_tit">
                            <h3 id="h3_list">상품목록</h3>
                            <div class="location">

                                <span><a th:href="@{'/market/main/'+${categoryDTOs.get(2).getId()}}">홈&nbsp;</a></span>
                                <span th:text="${categoryDTOs.get(2).getName()}">&nbsp;</span>
                                <span th:text="${categoryDTOs.get(1).getName()}"></span>
                                <span><strong>[[${categoryDTOs.get(0).getName()}]]&nbsp;</strong></span>
                            </div>
                        </div>
                        <div class="sort-options">
                            <ul>
                                <li th:classappend="${sort == 'popularity'} ? 'active' : ''">
                                    <a th:href="@{'/market/list/' + ${categoryDTOs.get(0).getId()} + '?sort=popularity'}">판매많은순</a>
                                </li>
                                <li th:classappend="${sort == 'lowPrice'} ? 'active' : ''">
                                    <a th:href="@{'/market/list/' +${categoryDTOs.get(0).getId()} + '?sort=lowPrice'}">낮은가격순</a>
                                </li>
                                <li th:classappend="${sort == 'highPrice'} ? 'active' : ''">
                                    <a th:href="@{'/market/list/' + ${categoryDTOs.get(0).getId()} + '?sort=highPrice'}">높은가격순</a>
                                </li>
                                <li th:classappend="${sort == 'rating'} ? 'active' : ''">
                                    <a th:href="@{'/market/list/' + ${categoryDTOs.get(0).getId()} + '?sort=rating'}">평점높은순</a>
                                </li>
                                <li th:classappend="${sort == 'reviews'} ? 'active' : ''">
                                    <a th:href="@{'/market/list/' + ${categoryDTOs.get(0).getId()} + '?sort=reviews'}">후기많은순</a>
                                </li>
                                <li th:classappend="${sort == 'recent'} ? 'active' : ''">
                                    <a th:href="@{'/market/list/' +${categoryDTOs.get(0).getId()}+ '?sort=recent'}">최근등록순</a>
                                </li>
                            </ul>
                        </div>
                        <div class="sub-category-options">
                            <ul class="sub-category-list">
                                <!-- 여기에 하위 카테고리 리스트가 동적으로 추가될 예정 -->
                            </ul>
                        </div>
                        <article class="product-list" th:if="${!responseDTO.getProductSummaryDTOs().isEmpty()}">
                            <div class="product-item" th:each="product:${responseDTO.getProductSummaryDTOs()}">
                                <a th:href="@{/market/view/{category}/{id}(category=${product.getCategoryId()},id=${product.productId})}">
                                <div class="product-image">
                                    <img th:src="@{'/uploads/'+${product.getFile230()}}" alt="상품 이미지">
                                </div>
                                <div class="product-details">
                                    <h4 class="product-name">[[${product.productName}]]</h4>
                                    <p class="product-description">[[${product.productDesc}]]</p>
                                </div>
                                <div class="price-seller-info">
                                    <div class="product-price">
                                        <span class="final-price">[[${product.finalPrice}]]원</span>
                                        <span class="original-price">[[${product.price}]]원</span>
                                        <span class="discount">[[${product.discount}]]%↓</span>

                                    </div>
                                    <div class="shipping-info">
                                        <span class="shipping-fee" th:text="${product.shippingFee}"></span>
                                    </div>
                                </div>
                                <div class="product-seller">
                                    <span class="seller-name">[[${product.company}]]</span>
                                    <span >고객만족우수</span>
                                    <div class="seller-rating" th:data-rating="${#numbers.formatDecimal(product.rating, 0, 1)}"></div>
                                    <p th:text="${product.rating} + ' (' + ${product.reviewCount} + ')'"></p>
                                </div>
                                </a>
                            </div>



                        </article> <!-- Repeat for more products -->


                    </div><!--sectionWrapper-->
                </section>






</th:block>